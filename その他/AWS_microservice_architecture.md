# AWSによるマイクロサービスのアーキテクチャパターン

https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/cloud-design-patterns/introduction.html

なんか探せば他のパターンも色々出てきそう。
[データ永続化を有効にするパターン](https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/modernization-data-persistence/database-per-service.html)

## 説明されている内容

- 腐敗防止レイヤー(ACL)
- APIルーティングパターン
  - ホスト名ルーティング
  - パスルーティング: メチャクチャトラフィックが多いときはk8sとかを使って自前でやるのが費用対効果が高い
  - HTTPヘッダルーティング: ヘッダの値でルーティングする。他のルーティングパターンと一緒に使われる。
- サーキットブレーカ
- ヘキサゴナルアーキテクチャ
- Publish-Subscribeパターン
- バックオフでの再試行
- Sagaパターン
  - Sagaコレオグラフィ
  - Sagaオーケストレーション
- Scatter-gather パターン
- Strangler fig パターン
- トランザクションアウトボックスパターン

### Sagaパターン

一連のローカルトランザクションによって構成される。  
各ローカルトランザクションはDBを更新して、次のローカルトランザクションをトリガーする。
もし、ローカルトランザクションが失敗した場合には、補償トランザクションを実行して前のローカルトランザクションを元に戻す。

ローカルトランザクションが失敗した場合は、継続(トランザクションの再試行)か補償(データを前の状態に戻す)のどちらかが行われる。

プラットフォームレベルの障害(インフラによるトランザクション失敗)の場合は、再試行を行う。  
アプリケーションレベルの障害の場合は、補償トランザクションでDBを処理前の状態に戻す。

Sagaパターンには、SagaコレオグラフィとSagaオーケストレーションの2つのバリエーションがある。

#### Sagaコレオグラフィ

Sagaパターンを構成するサービスがイベント駆動で、各サービスがイベントを発行し、他のサービスがそのイベントを受信して処理を行う。  
構成サービスが少ない場合に使われる。

#### Sagaオーケストレーション

オーケストレーターと呼ばれる中央集権的なコンポーネントが、各ローカルトランザクションの実行を管理する。  
構成サービスが多い場合に有効だが、オーケストレータが単一障害点になる。

### Scatter-gather パターン

同時に複数のサービスにリクエストを送信するパターン。  
全部帰ってきてからそのレスポンスをまとめる。
そのうちいくつかが帰ってこないパターンなどに対処する必要がある。

### Strangler figパターン

モノリシックアプリケーションをマイクロサービスに移行する際に使うパターン。  
ACLを使って少しずつ新しいマイクロサービスにトラフィックを移行していく。  
ACLが自システムと他システムとをつなげる役割を果たすのに対して、こちらはACLを使ってモノリシックシステムと新しいマイクロサービスで置き換えるためのパターン。

- 段階的な移行: 機能を一つずつ新しいマイクロサービスに移行していく
- 移行中はモノリシックアプリケーションと新しいマイクロサービスが並行して動作する。

### トランザクションアウトボックスパターン

DBの保存と外部サービスへのAPIリクエストなどのメッセージングを同時に行い、整合と取る必要がある場合に使うパターン。

アウトボックステーブルを用意して、メッセージングの内容を保存しておき、トランザクションが成功したらアウトボックステーブルの内容を処理する。  
別のプロセスでアウトボックステーブルにポーリングをして、取得できた場合にはメッセージングを行い。メッセージングが成功したらテーブルの内容を削除する。かフラグを立てる。